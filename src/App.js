// App.js
import React, { useEffect, useState } from "react";
import './App.css';
/* ethers å¤‰æ•°ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ */
import { ethers } from "ethers";
// ethers ã®æ§˜ã€…ãªã‚¯ãƒ©ã‚¹ã‚„é–¢æ•°ã¯ã€ethersprojectãŒæä¾›ã™ã‚‹ã‚µãƒ–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹
//    -> WEBã‚¢ãƒ—ãƒªã‹ã‚‰ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’å‘¼ã³å‡ºã™æ™‚ã«å¿…é ˆã¨ãªã‚‹
/* ABIãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€WavePortal.jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ */
import abi from "./utils/WavePortal.json";

const App = () => {
  /*ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹å¤‰æ•°ã¨é–¢æ•°ã‚’å®šç¾©ã—ã€åˆæœŸåŒ–ã—ã¦ã„ã‚‹ ã“ã“ã‹ã‚‰... */
  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹çŠ¶æ…‹å¤‰æ•°ã‚’å®šç¾©ã—ã¾ã™ */
  const [currentAccount, setCurrentAccount] = useState("");
  //    -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ ¼ç´ã™ã‚‹æ•°(= currentAccount)
  //    ->  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°(= setCurrentAccount)

  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿æŒã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹çŠ¶æ…‹å¤‰æ•°ã‚’å®šç¾© */
  const [messageValue, setMessageValue] = useState("");
  //    -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°(= messageValue)
  //    -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°(= setMessageValue)

  /* å…¨ã¦ã®wavesã‚’ä¿å­˜ã™ã‚‹çŠ¶æ…‹å¤‰æ•°ã‚’å®šç¾© */
  const [allWaves, setAllWaves] = useState([]);
  //    -> ç¾åœ¨ã®wavesã®çŠ¶æ…‹ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°(= allWaves)
  //    -> ç¾åœ¨ã®wavesã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°(= setAllWaves)

  /* ...ã“ã“ã¾ã§ */

  /* ã“ã®æ®µéšã§ currentAccount ã®ä¸­èº«ã¯ç©º */
  // ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ¤œå‡ºã—ãŸå¾Œã€currentAccount ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ(0x...)ã®å€¤ãŒå…¥ã‚‹
  console.log("currentAccount: ", currentAccount);

  /* ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°ã‚’ä½œæˆ */
  const contractAddress = "0x04bDEC5C41616Fa68eF3EBBdf7E92C31948358c7";

  /* ABIã®å†…å®¹ã‚’å‚ç…§ã™ã‚‹å¤‰æ•°ã‚’ä½œæˆ */
  const contractABI = abi.abi;

  const getAllWaves = async () => {
    const { ethereum } = window;

    try {
      if (ethereum) {
        const provider = new ethers.providers.Web3Provider(ethereum);
        // ã“ã“ã§ã¯ã€provider(= MetaMask) ã‚’è¨­å®šã—ã¦ã„ã‚‹
        //    -> ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒMetaMaskã‚’ä»‹ã—ã¦ã€ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ãƒãƒ¼ãƒ‰ã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
        const signer = provider.getSigner();
        // ã“ã“ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹(= signer)ã‚’è¨­å®šã—ã¦ã„ã‚‹
        const wavePortalContract = new ethers.Contract(contractAddress, contractABI, signer);
        // ã“ã“ã§ã¯ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹(= wavePortalContract)ã‚’ç”Ÿæˆã—ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¸ã®æ¥ç¶šã‚’è¡Œã£ã¦ã„ã‚‹
        // waveé–¢æ•°åŒæ§˜ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®3ã¤ã‚’ethers.Contracté–¢æ•°ã«æ¸¡ã™å¿…è¦ãŒã‚ã‚‹
        //    -> 1.ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹(ãƒ­ãƒ¼ã‚«ãƒ«ã€ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã€ã¾ãŸã¯ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ãƒãƒƒãƒˆ)
        //    -> 2.ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ABI
        //    -> 3.providerã€ã‚‚ã—ãã¯signer
        // ä»Šå›ã¯ã€signerã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã—ã¦ã„ã‚‹ã®ã§ã€wavePortalContractã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€Œèª­ã¿å–ã‚Šã€ã¨ã€Œæ›¸ãè¾¼ã¿ã€ã®ä¸¡æ–¹ã®æ©Ÿèƒ½ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹

        /* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰getAllWavesãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ */
        const waves = await wavePortalContract.getAllWaves();

        /* ã“ã“ã§ã¯çŠ¶æ…‹å¤‰æ•°(= waveCleaned)ã«ã€mapãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¦ã„ã‚‹ ã“ã“ã‹ã‚‰... */
        /* UIã«å¿…è¦ãªã®ã¯ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ãªã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®š */
        const wavesCleaned = waves.map(wave => {
          // mapãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€å…ƒã¨ãªã‚‹é…åˆ—ã‹ã‚‰æ–°ã—ãé…åˆ—ã‚’ä½œã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰
          // é…åˆ—ã®å…¨ã¦ã®è¦ç´ ã«å¯¾ã—ã¦ã€ä¸ãˆã‚‰ã‚ŒãŸé–¢æ•°ã‚’å®Ÿè¡Œã—ã€é–¢æ•°ã§è¿”ã•ã‚ŒãŸå€¤ã§æ–°ã—ã„é…åˆ—ã‚’ç”Ÿæˆã™ã‚‹
          // mapãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ä¸‹è¨˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã€wavesCleanedã«æ ¼ç´ã•ã‚Œã‚‹
          //    -> waveã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹(=address)
          //    -> é€ä¿¡ã—ãŸæ™‚é–“(= timestamp)
          //    -> ä»˜éšã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸(= message)
          return {
            address: wave.waver,
            timestamp: new Date(wave.timestamp * 1000),
            message: wave.message,
          };
        });
        // ã“ã“ã§ã¯.map()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦wavesé…åˆ—ã‚’ãƒ«ãƒ¼ãƒ—ã—ã€é…åˆ—å†…ã®å„é …ç›®ã®è¦ç´ ã‚’è¿”ã—ã¦ã„ã‚‹
        // ä»Šå›è¿”ã™è¦ç´ ã¯ã€ä»¥ä¸‹ã®é€šã‚Š
        //    -> address : waveã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
        //    -> timestamp : waveã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
        //    -> message : waveã¨å…±ã«é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        /* React Stateã«ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹*/
        setAllWaves(wavesCleaned);
        // ã“ã‚Œã§ã€æ–°ã—ã„waveã®æƒ…å ±ãŒwaveså¤‰æ•°ã«æ–°ãŸãªé…åˆ—ã¨ã—ã¦è¿½åŠ ã•ã‚Œã‚‹

        /* ...ã“ã“ã¾ã§ */

      } else {
        console.log("Ethereum object doesn't exist!");
      }
    } catch (error) {
      console.log(error);
    }
  };

  /*
    'emit'ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã«åå¿œã™ã‚‹
  */
  useEffect(() => {
    let wavePortalContract;

    const onNewWave = (from, timestamp, message) => {
      console.log("NewWave", from, timestamp, message);
      setAllWaves(prevState => [
        ...prevState,
        {
          address: from,
          timestamp: new Date(timestamp * 1000),
          message: message,
        },
      ]);
    };
    // ã“ã“ã§ã¯ä¸‹è¨˜ã®2ã¤ã®å‹•ä½œã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹
    //    -> ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå´ã§æ–°ã—ãNewWaveã‚¤ãƒ™ãƒ³ãƒˆãŒemitã•ã‚ŒãŸæ™‚ã€ä¸‹è¨˜ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
    //        -> senderã®ã‚¢ãƒ‰ãƒ¬ã‚¹
    //        -> senderãŒNewWaveã‚’emitã—ãŸã¨ãã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    //        -> messageã®å†…å®¹
    //       ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãã‚Œã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
    //    -> NewWaveã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒå—ã‘å–ã£ãŸæ™‚ã«setAllWavesã‚’å®Ÿè¡Œã™ã‚‹
    //        -> NewWaveã‚¤ãƒ™ãƒ³ãƒˆãŒemitã•ã‚ŒãŸéš›ã«ã€ä¸Šè¨˜ã§å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹3ã¤ã®æƒ…å ±ãŒallWavesé…åˆ—ã«è¿½åŠ ã•ã‚Œã‚‹
    //        -> ã“ã‚Œã«ã‚ˆã‚Šã€WEBã‚¢ãƒ—ãƒªã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«åæ˜ ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ã§æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
    // ã“ã®OnNewWaveé–¢æ•°ã¯ã€NewWaveã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åƒãã‚’ã—ã¦ã„ã‚‹
    //    -> ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨ã¯ã€Œãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸã€ã€ã€Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã€ãªã©ã®å‹•ä½œã®ã“ã¨ã‚’è¡¨ã™
    //        -> ã“ã“ã§ã¯ã€ã€Œãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ wave ã‚’é€ã£ãŸã€å‹•ä½œã‚’å—ã‘å–ã‚‹
    //        -> Javascriptã§ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸéš›ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«å¯¾å¿œä»˜ã‘ã¦ãŠã„ãŸé–¢æ•°ã®ã“ã¨ã‚’ã€Œã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã€ã¨å‘¼ã¶

    /* NewWaveã‚¤ãƒ™ãƒ³ãƒˆãŒã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰ç™ºä¿¡ã•ã‚ŒãŸã¨ãã«ã€æƒ…å ±ã‚’å—ã‘ã‚‹ */
    if (window.ethereum) {
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();

      wavePortalContract = new ethers.Contract(contractAddress, contractABI, signer);

      wavePortalContract.on("NewWave", onNewWave);
      // wavePortalContract.on("NewWave", onNewWave)ã«ã‚ˆã‚Šã€ä¸Šè¨˜ã§å®šç¾©ã—ãŸ onNewWave ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹
    }

    /* ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ããŸã‚ã«ã€NewWaveã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è§£é™¤ã—ã¾ã™ */
    return () => {
      if (wavePortalContract) {

        wavePortalContract.off("NewWave", onNewWave);
        // wavePortalContract.on("NewWave", onNewWave)ã«ã‚ˆã‚Šã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ã€NewWaveã‚¤ãƒ™ãƒ³ãƒˆãŒã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰ç™ºä¿¡ã•ã‚ŒãŸã¨ãã«ã€æƒ…å ±ã‚’å—ã‘å–ã‚‹
        //    -> ã“ã‚Œã«ã‚ˆã‚Šã€æƒ…å ±ãŒãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«åæ˜ ã•ã‚Œã‚‹
        //    -> ã“ã®ã“ã¨ã‚’ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ(æƒ…å ±)ãŒãƒã‚¦ãƒ³ãƒˆ(ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«åæ˜ )ã•ã‚Œã‚‹ã¨è¨€ã†
        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹çŠ¶æ…‹ã‚’ãã®ã¾ã¾ã«ã—ã¦ãŠãã¨ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯(ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’å‹•ä½œã•ã›ã¦ã„ã‚‹å†…ã«ã€ä½¿ç”¨å¯èƒ½ãªãƒ¡ãƒ¢ãƒªã®å®¹é‡ãŒæ¸›ã£ã¦ã„ã£ã¦ã—ã¾ã†ç¾è±¡)ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
        // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ããŸã‚ã«ã€wavePortalContract.off("NewWave", onNewWave)ã§ã¯ã€onNewWaveé–¢æ•°ã®ç¨¼åƒã‚’æ­¢ã‚ã¦ã„ã‚‹
        //    -> ã“ã‚Œã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ­¢ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¦ã„ã‚‹
      }
    };
  }, []);

  /* window.ethereum ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ */
  const checkIfWalletIsConnected = async () => {
    try {
      const { ethereum } = window;
      if (!ethereum) {
        console.log("Make sure you have MetaMask!");
        return;
      } else {
        console.log("We have the ethereum object", ethereum);
      }

      /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ */
      // accounts ã«WEBã‚µã‚¤ãƒˆã‚’è¨ªã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ ¼ç´ã™ã‚‹(è¤‡æ•°æŒã£ã¦ã„ã‚‹å ´åˆã‚‚åŠ å‘³ã€ã‚ˆã£ã¦ account's' ã¨å¤‰æ•°ã‚’å®šç¾©ã—ã¦ã„ã‚‹)
      const accounts = await ethereum.request({ method: "eth_accounts" });
      // eth_accounts ã¯ã€ç©ºã®é…åˆ—ã¾ãŸã¯å˜ä¸€ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã‚€é…åˆ—ã‚’è¿”ã™ç‰¹åˆ¥ãªãƒ¡ã‚½ãƒƒãƒ‰

      /* ã‚‚ã—ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒ1ã¤ã§ã‚‚å­˜åœ¨ã—ãŸã‚‰ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œ */
      /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Found an authorized account ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã•ã‚Œã‚‹*/
      if (accounts.length !== 0) {
        const account = accounts[0];
        // account ã¨ã„ã†å¤‰æ•°ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€ã¤ç›®(=Javascriptã§ã„ã†0ç•ªç›®)ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¼ç´
        console.log("Found an authorized account:", account);
        /* currentAccount ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¼ç´ */
        setCurrentAccount(account)
        getAllWaves();
      } else {
        /* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ› */
        console.log("No authorized account found");
      }
    } catch (error) {
      console.log(error);
    }
  }

  /* connectWallet ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£… */
  //    -> eth_requestAccountsé–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€MetaMaskã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ã‚ˆã†å‘¼ã³æ›ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹
  const connectWallet = async () => {
    try {
      const { ethereum } = window;
      if (!ethereum) {
        alert("Get MetaMask!");
        return;
      }
      const accounts = await ethereum.request({ method: "eth_requestAccounts" });
      console.log("Connected: ", accounts[0]);
      setCurrentAccount(accounts[0]);
    } catch (error) {
      console.log(error)
    }
  }

  // waveã®å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹é–¢æ•°ã‚’å®Ÿè£…
  const wave = async () => {
    try {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒMetaMaskã‚’æŒã£ã¦ã„ã‚‹ã‹ç¢ºèª
      const { ethereum } = window;
      if (ethereum) {
        const provider = new ethers.providers.Web3Provider(ethereum);
        // ã“ã“ã§ã¯ã€provider(=MetaMask)ã‚’è¨­å®šã—ã¦ã„ã‚‹
        // provider ã‚’ä»‹ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã«å­˜åœ¨ã™ã‚‹ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ãƒãƒ¼ãƒ‰ã«æ¥ç¶šã™ã‚‹ã“ã¨ãŒã§ãã‚‹
        // MetaMaskãŒæä¾›ã™ã‚‹ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ãƒãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ã™ã‚‹ãŸã‚ã«ä¸Šè¨˜ã®å®Ÿè£…ã‚’è¡Œã£ãŸ
        // ethers ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã‚Š provider ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ–°è¦ä½œæˆ
        const signer = provider.getSigner();
        // singer ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½è±¡åŒ–ã—ãŸã‚‚ã®
        // provider ã‚’ä½œæˆã—ã€provider.getSigner() ã‚’å‘¼ã³å‡ºã™ã ã‘ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ç½²åã—ã€ãã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
        // provider.getSinger() ã¯ã€æ–°ã—ã„ signer ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã®ã§ã€ãã‚Œã‚’ä½¿ã£ã¦ç½²åä»˜ããƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã‚‹

        /* ABIã‚’å‚ç…§ */
        const wavePortalContract = new ethers.Contract(contractAddress, contractABI, signer);
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¸ã®æ¥ç¶šã‚’è¡Œã£ã¦ã„ã‚‹
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ¶ä½œã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ï¼“ã¤ã®å¤‰æ•°ã‚’ ethers.Contract é–¢æ•°ã«æ¸¡ã™å¿…è¦ãŒã‚ã‚‹
        //    -> ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹(ãƒ­ãƒ¼ã‚«ãƒ«ã€ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã€ã¾ãŸã¯ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ãƒãƒƒãƒˆ)
        //    -> ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ABI
        //    -> provider ã‚‚ã—ãã¯ signer
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹
        // ã‚‚ã—ã“ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã« provider ã‚’æ¸¡ã™ã¨ã€ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯èª­ã¿å–ã‚Šå°‚ç”¨ã®æ©Ÿèƒ½ã—ã‹å®Ÿè¡Œã§ããªããªã‚‹
        // ä¸€æ–¹ã€signer ã‚’æ¸¡ã™ã¨ã€ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã®ä¸¡æ–¹ã®æ©Ÿèƒ½ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™

        let count = await wavePortalContract.getTotalWaves();
        console.log("Retrieved total wave count...", count.toNumber());

        let contractBalance = await provider.getBalance(
          wavePortalContract.address
        );
        console.log(
          "Contract balance:",
          ethers.utils.formatEther(contractBalance)
        );

        /* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«waveã‚’æ›¸ãè¾¼ã‚€ã€‚ ã“ã“ã‹ã‚‰... */
        const waveTxn = await wavePortalContract.wave(messageValue, { gasLimit: 300000 });
        // gasLimitã¯ã€ã€Œã‚¬ã‚¹é‡ã€ã®æœ€å¤§å€¤(ä¸Šé™)ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼
        // ã“ã‚Œã¯ã€é€é‡‘å…ˆã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å•é¡Œãªã©ã§ã€ãšã£ã¨å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œç¶šã‘ã¦ã€é€é‡‘æ‰‹æ•°æ–™ã®æ”¯æ‰•ã„ãŒç„¡é™ã«ç™ºç”Ÿã™ã‚‹(ã€Œã‚¬ã‚¹é‡ã€ãŒç„¡é™ã«å¤§ãããªã‚‹)ã“ã¨ã‚’é˜²ããŸã‚ã®ã‚‚ã®
        // ã‚¬ã‚¹é‡ãŒgasLimitã§è¨­å®šã•ã‚ŒãŸæ•°å€¤ä»¥ä¸Šã«ãªã£ãŸå ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­ã—ã¦ã€ãã‚Œä»¥ä¸Šã®é€é‡‘æ‰‹æ•°æ–™ãŒç™ºç”Ÿã—ãªã„ã‚ˆã†ãªä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹
        //    -> ã¤ã¾ã‚Šã€é€é‡‘æ‰‹æ•°æ–™ã¨ã—ã¦æ”¯æ‰•ã†æœ€å¤§å€¤(ä¸Šé™)ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
        //            -> æœ€å¤§é€é‡‘æ‰‹æ•°æ–™(ETH) = ã‚¬ã‚¹ä¾¡æ ¼ Ã— ã‚¬ã‚¹ãƒªãƒŸãƒƒãƒˆ

        console.log("Mining...", waveTxn.hash);
        await waveTxn.wait();
        console.log("Mined -- ", waveTxn.hash);
        count = await wavePortalContract.getTotalWaves();
        console.log("Retrieved total wave count...", count.toNumber());
        /* ã“ã“ã¾ã§ */

        let contractBalance_post = await provider.getBalance(wavePortalContract.address);
        /* ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ®‹é«˜ãŒæ¸›ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª */
        if (contractBalance_post < contractBalance) {
          /* æ¸›ã£ã¦ã„ãŸã‚‰ä¸‹è¨˜ã‚’å‡ºåŠ› */
          console.log("User won ETH!");
        } else {
          console.log("User didn't win ETH.");
        }
        console.log(
          "Contract balance after wave:",
          ethers.utils.formatEther(contractBalance_post)
        );
      } else {
        console.log("Ethereum object doesn't exist!");
      }
    } catch (error) {
      console.log(error)
    }
  }

  /* WEBãƒšãƒ¼ã‚¸ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã¨ãã«ä¸‹è¨˜ã®é–¢æ•°ã‚’å®Ÿè¡Œã—ã¾ã™ */
  useEffect(() => {
    checkIfWalletIsConnected();
  }, [])

  return (
    <div className="mainContainer">
      <div className="dataContainer">

        <div className="header">
          <span role="img" aria-label="hand-wave">ğŸ‘‹</span> WELCOME!
        </div>

        <div className="bio">
          ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ãŸã‚‰ã€<span role="img" aria-label="hand-wave">ğŸ‘‹</span>ã‚’é€ã£ã¦ãã ã•ã„<span role="img" aria-label="shine">âœ¨</span>
        </div>

        {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’å®Ÿè£… */}
        {currentAccount && (<textarea name="messageArea"
          placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã“ã¡ã‚‰"
          type="text"
          id="message"
          value={messageValue}
          onChange={e => setMessageValue(e.target.value)} />)
          // ã“ã‚Œã¯ã€èªè¨¼æ¸ˆã¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹(= currentAccount)ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ã€ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’UIã«è¡¨ç¤ºã™ã‚‹ä»•æ§˜ã«ãªã£ã¦ã„ã‚‹
          // ã“ã‚Œã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€UIã‹ã‚‰ç›´æ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ãè¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹
        }

        <br />
        {/* ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚³ãƒã‚¯ãƒˆã®ãƒœã‚¿ãƒ³ã‚’å®Ÿè£… */}
        {!currentAccount && (
          <button className="waveButton" onClick={connectWallet} >
            Connect Wallet
          </button>
        )}
        {currentAccount && (
          <button className="waveButton">
            Wallet Connected
          </button>
        )}

        {/* waveãƒœã‚¿ãƒ³ã«waveé–¢æ•°ã‚’é€£å‹•ã•ã›ã‚‹ */}
        {currentAccount && (
          <button className="waveButton" onClick={wave}>
            Wave at Me
          </button>)
        }
        {/* onClick ãƒ—ãƒ­ãƒƒãƒ—ã‚’nullã‹ã‚‰waveã«æ›´æ–°ã—ã¦ã€wave() é–¢æ•°ã‚’ waveButton ã«æ¥ç¶šã—ã¦ã„ã‚‹ */}

        {/* å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ */}
        {currentAccount && (
          allWaves.slice(0).reverse().map((wave, index) => {
            return (
              <div key={index} style={{ backgroundColor: "#F8F8FF", marginTop: "16px", padding: "8px" }}>
                <div>Address: {wave.address}</div>
                <div>Time: {wave.timestamp.toString()}</div>
                <div>Message: {wave.message}</div>
              </div>)
          })
        )}
      </div>
    </div>
  );
}

export default App

/*
ABI (Application Binary Interface) ã¯ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®å–ã‚Šæ‰±ã„èª¬æ˜æ›¸ã®ã‚ˆã†ãªã‚‚ã®

WEBã‚¢ãƒ—ãƒªãŒã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¨é€šä¿¡ã™ã‚‹ãŸã‚ã«å¿…è¦ãªæƒ…å ±ãŒã€ABI ãƒ•ã‚¡ã‚¤ãƒ«ã«å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆä¸€ã¤ä¸€ã¤ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãª ABI ãƒ•ã‚¡ã‚¤ãƒ«ãŒç´ã¥ã„ã¦ãŠã‚Šã€ãã®ä¸­ã«ã¯ä¸‹è¨˜ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹

  -> ãã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹é–¢æ•°ã®åå‰
  -> ãã‚Œãã‚Œã®é–¢æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ãã®å‹
  -> é–¢æ•°ã®å®Ÿè¡Œçµæœã«å¯¾ã—ã¦è¿”ã‚‹ãƒ‡ãƒ¼ã‚¿å‹ã®ç¨®é¡

ABI ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸæ™‚ã«ç”Ÿæˆã•ã‚Œã€artifacts ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«è‡ªå‹•çš„ã«æ ¼ç´ã•ã‚Œã‚‹
*/


/*
ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€ã‚³ãƒ¼ãƒ‰ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã‚³ãƒ¼ãƒ‰ã«ä¼¼ã¦ã„ã‚‹

ä¸»ãªé•ã„ã¯ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€ã¨ãã¯ã€ãƒã‚¤ãƒŠãƒ¼ã«é€šçŸ¥ãŒé€ã‚‰ã‚Œã€
ãã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®æ‰¿èªãŒæ±‚ã‚ã‚‰ã‚‹ã“ã¨

ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã¨ãã¯ã€ãã®ã‚ˆã†ãªã“ã¨ã‚’ã™ã‚‹å¿…è¦ã¯ãªã„
ã‚ˆã£ã¦ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Šã¯ç„¡æ–™
*/


/*
ã‚¬ã‚¹ä¾¡æ ¼ã¨ã¯

é€é‡‘æ‰‹æ•°æ–™ã‚’æ±ºã‚ã‚‹ã€ã‚‚ã†1ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã€Œã‚¬ã‚¹ä¾¡æ ¼ã€
ã‚¬ã‚¹ä¾¡æ ¼ã¯ã€1Gaså½“ãŸã‚Šã®ä¾¡æ ¼ã‚’æ„å‘³ã—ã¾ã™
åŸºæœ¬çš„ãª1Gaså½“ãŸã‚Šã®ä¾¡æ ¼ã¯ã€Œ21 Gweiã€ã§é€é‡‘ã•ã‚Œã‚‹
ã‚¬ã‚¹ä¾¡æ ¼ã®å˜ä½ã¨ã—ã¦ä½¿ã‚ã‚Œã¦ã„ã‚‹ã€Œweiã€ã¨ã€ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ã®å˜ä½ã®é–¢ä¿‚ã¯æ¤œç´¢
(1ETH = 1000000000000000000wei)
Gã¯ã‚®ã‚¬ã®ã“ã¨ã§ã€1Gwei = 0.000000001ETH
ã‚¬ã‚¹ä¾¡æ ¼ã¯ã€é€é‡‘è€…ãŒè‡ªç”±ã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹
ãƒã‚¤ãƒŠãƒ¼ã¯ã€ã‚¬ã‚¹ä¾¡æ ¼ãŒé«˜ã„(= ãƒã‚¤ãƒ‹ãƒ³ã‚°å ±é…¬ãŒå¤šã„)ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å„ªå…ˆçš„ã«æ‰¿èªã™ã‚‹
    -> ã‚¬ã‚¹ä¾¡æ ¼ã‚’é«˜ãè¨­å®šã—ã¦ãŠãã¨ã€é€é‡‘ãŒæ—©ããªã‚‹å‚¾å‘ãŒã‚ã‚‹
*/